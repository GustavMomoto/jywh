<!DOCTYPE html>
<html lang="zh-Hans-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>玖宇万合剧场收益计算工具</title>
  <link rel="icon" href="./images/favicon.png"
    type="image/png">
</head>

<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-image:
      linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.95)),
      url("https://gustavmomoto.github.io/jywh/images/background.jpg");
    background-attachment: fixed;
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
  }

  #title_div {
    text-align: center;
    flex-direction: column;
    width: 362px;
    height: 82px;
    border-radius: 15px;
    margin-bottom: 15px;
    background-image: linear-gradient(45deg, #d9a1e0, #445ad8);
  }

  #args_div {
    text-align: left;
    width: 362px;
    height: 400px;
    border-radius: 15px;
    margin-bottom: 10px;
    background-image: linear-gradient(to right, #d9a1e0, #445ad8);
  }

  #args_title {
    text-align: center;
  }

  .args {
    text-indent: 1em;
    /* 缩进字符 */
    text-align: right;
    padding-right: 30px;
  }

  .args_class_div {
    width: 362px;
    /* height: 75px; */
    border-radius: 10px;
    background-image: linear-gradient(45deg, #445ad8, #d9a1e0);
    align-items: center;
  }

  .select {
    text-align: center;
  }

  input,
  select {
    width: 120px;
    padding: 4px;
  }

  .input_num {
    text-align: center;
  }

  /* 新增按钮样式 */
  #button_div {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  button {
    padding: 8px 20px;
    border-radius: 5px;
    border: none;
    background: linear-gradient(45deg, #445ad8, #d9a1e0);
    color: white;
    cursor: pointer;
  }

  #result_div {
    width: 332px;
    padding: 15px;
    border-radius: 15px;
    background-image: linear-gradient(to right, #d9a1e0, #445ad8);
    color: white;
  }
</style>

<body>
  <div id="title_div">
    <h1>玖宇万合剧场收益模拟器</h1>
  </div>

  <div id="args_div">
    <div class="args_class_div">
      <h3 class="args">请选择您的身份：
        <select class="select">
          <option value="SVIP">SVIP</option>
          <option value="一星服务商">一星服务商</option>
          <option value="二星服务商">二星服务商</option>
          <option value="三星服务商">三星服务商</option>
        </select>
      </h3>
    </div>

    <h3 id="args_title">您的下级信息</h3>
    <div>
      <div class="args_class_div">
        <h3 class="args">会员数量：
          <input class="input_num" type="number" value="0" min="0" step="1">
        </h3>

        <h3 class="args">人均消费额：
          <input class="input_num" type="number" value="1000" min="0" step="100">
        </h3>
      </div>

      <div class="args_class_div">
        <h3 class="args">一星服务商数量：
          <input class="input_num" type="number" value="0" min="0" step="1">
        </h3>
        <h3 class="args">人均消费额：
          <input class="input_num" type="number" value="1000" min="0" step="100">
        </h3>
      </div>

      <div class="args_class_div">
        <h3 class="args">二星服务商数量：
          <input class="input_num" type="number" value="0" min="0" step="1">
        </h3>
        <h3 class="args">人均消费额：
          <input class="input_num" type="number" value="1000" min="0" step="100">
        </h3>
      </div>
    </div>
  </div>

  <!-- 新增按钮区域 -->
  <div id="button_div">
    <!-- <button onclick="calculateProfit()">计算收益</button> -->
    <button onclick="resetAll()">重置参数</button>
    <button onclick="saveResults()">保存结果</button>
  </div>

  <!-- 新增结果显示区域 -->
  <div id="result_div">
    <h3>计算结果：</h3>
    <p>总消费额：<span id="total_consumption">0</span></p>
    <p>预计收益：<span id="total_profit">0</span></p>
  </div>
</body>

<script>
  // 统一事件监听（支持动态新增元素）
  document.addEventListener('input', function (e) {
    if (e.target.classList.contains('input_num')) {
      validateNumber(e.target);
    }
  });
  document.addEventListener('keydown', function (e) {
    if (e.target.classList.contains('input_num')) {
      // 阻止输入字母E和小数点
      if (e.keyCode === 69 || e.keyCode === 190) e.preventDefault();
    }
  });
  // 通用验证函数
  function validateNumber(input) {
    input.value = input.value
      .replace(/[^0-9]/g, '')      // 过滤非数字
      .replace(/^0+(\d)/, '$1');    // 去除前导零（保留最后一位）

    if (!input.value || input.value < input.min) {
      input.value = input.min || 0; // 保证最小值
    }
  }
   window.addEventListener('beforeunload', function (event) {
     var message = '你确定要离开这个页面吗？所有未保存的更改将会丢失。';
     event.returnValue = message;
     return message;
   });
 // 修正后的显示控制逻辑
 function updateDisplay() {
    const identity = document.querySelector('select').value;
    const groups = document.querySelectorAll('#args_div > div:nth-child(3) > .args_class_div');
    
    groups.forEach((div, index) => {
      div.style.display = 
        (identity === 'SVIP' || identity === '一星服务商') ? 
          index === 0 ? 'block' : 'none' :
        identity === '二星服务商' ?
          index < 2 ? 'block' : 'none' :
          'block';
    });
  }

  // 修复后的计算逻辑
  function calculateProfit() {
    const identity = document.querySelector('select').value;
    let total = 0;
    const inputs = document.querySelectorAll('.args_class_div input');

    // 始终计算会员部分
    total += parseInt(inputs[0].value || 0) * parseInt(inputs[1].value || 1000);

    // 动态检测元素可见性
    const oneStarDiv = document.querySelector('#args_div > div:nth-child(3) > .args_class_div:nth-child(2)');
    const twoStarDiv = document.querySelector('#args_div > div:nth-child(3) > .args_class_div:nth-child(3)');

    // 计算一星服务商（如果可见）
    if (window.getComputedStyle(oneStarDiv).display !== 'none') {
      total += parseInt(inputs[2].value || 0) * parseInt(inputs[3].value || 1000);
    }

    // 计算二星服务商（如果可见）
    if (window.getComputedStyle(twoStarDiv).display !== 'none') {
      total += parseInt(inputs[4].value || 0) * parseInt(inputs[5].value || 1000);
    }

    // 计算收益
    let threshold = 0, reward = 0;
    switch(identity) {
      case 'SVIP':
      case '一星服务商':
        threshold = 50000;
        reward = 1500;
        break;
      case '二星服务商':
        threshold = 100000;
        reward = 2500;
        break;
      case '三星服务商':
        threshold = 150000;
        reward = 3500;
        break;
    }
    
    const profit = threshold > 0 ? Math.floor(total / threshold) * reward : 0;
    document.getElementById('total_consumption').textContent = total;
    document.getElementById('total_profit').textContent = profit;
  }

  // 增强重置功能
  function resetAll() {
    document.querySelectorAll('.input_num').forEach(input => {
      const isCount = input.parentElement.textContent.includes('数量');
      input.value = isCount ? 0 : 1000;
    });
    document.querySelector('select').value = 'SVIP';
    updateDisplay();
    calculateProfit();
  }

  // 修复后的保存功能
  function saveResults() {
    const content = `计算时间：${new Date().toLocaleString()}
用户身份：${document.querySelector('select').value}
下级信息：
${Array.from(document.querySelectorAll('#args_div > div:nth-child(3) > .args_class_div'))
  .filter(div => window.getComputedStyle(div).display !== 'none')
  .map(div => {
    const labels = Array.from(div.querySelectorAll('h3')).map(h3 => h3.textContent.trim().replace(/：$/, ''));
    const values = Array.from(div.querySelectorAll('input')).map(input => input.value);
    return `${labels[0]}：${values[0]}，${labels[1]}：${values[1]}`;
  })
  .join('\n')}
最终结果：
总消费额：${document.getElementById('total_consumption').textContent}
预计收益：${document.getElementById('total_profit').textContent}`;

    const blob = new Blob([content], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `收益计算结果_${new Date().getTime()}.txt`;
    link.click();
  }

  // 初始化时自动重置
  document.addEventListener('DOMContentLoaded', () => {
    resetAll();
    document.querySelector('select').addEventListener('change', () => {
      updateDisplay();
      calculateProfit();
    });
    document.addEventListener('input', () => calculateProfit());
  });
</script>

</html>
